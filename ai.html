<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Funfu AI Chat</title>
<style>
body {font-family:Arial,sans-serif;margin:0;background:#f9f9f9;}
main {padding:20px;max-width:700px;margin:auto;}
#chat-output {border:1px solid #ccc;height:400px;overflow-y:auto;padding:10px;background:#fff;margin-bottom:10px;border-radius:4px;}
#chat-input {width:calc(100% - 100px);padding:10px;font-size:14px;}
button {padding:10px;width:80px;background:#0a59a6;color:white;border:none;border-radius:4px;cursor:pointer;}
button:hover {background:#094a86;}
form {display:flex;gap:10px;}
p {margin:5px 0;}
</style>
</head>
<body>

<main>
  <h2>Funfu AI Chat</h2>
  <div id="chat-output"></div>
  <form id="chat-form">
    <input id="chat-input" placeholder="Ask something..." required>
    <button type="submit">Send</button>
  </form>
</main>

<!-- Module script for navbar + Firebase auth -->
<script type="module">
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

// Redirect to signup if user is not logged in
onAuthStateChanged(getAuth(), user => {
  if (!user) {
    window.location.href = "signup.html";
  }
});
</script>

<!-- Load Puter.ai -->
<script src="https://js.puter.com/v2/"></script>

<!-- Normal script for AI chat -->
<script>
const form = document.getElementById('chat-form');
const input = document.getElementById('chat-input');
const output = document.getElementById('chat-output');

// Wait until Puter is loaded
function waitForPuter(timeout = 5000) {
  return new Promise((resolve, reject) => {
    const start = Date.now();
    const interval = setInterval(() => {
      if (window.puter) {
        clearInterval(interval);
        resolve();
      } else if (Date.now() - start > timeout) {
        clearInterval(interval);
        reject(new Error("Puter.ai did not load in time"));
      }
    }, 50);
  });
}

waitForPuter().then(() => {
  form.addEventListener('submit', async function(e){
    e.preventDefault();
    const question = input.value.trim();
    if(!question) return;

    output.innerHTML += `<p><b>You:</b> ${question}</p>`;
    input.value = "";

    try {
      const response = await puter.ai.chat(question, { model: "gpt-5-nano" });
      output.innerHTML += `<p><b>AI:</b> ${response}</p>`;
      output.scrollTop = output.scrollHeight;
    } catch(err) {
      output.innerHTML += `<p><b>AI:</b> Error: ${err.message}</p>`;
    }
  });
}).catch(err => {
  output.innerHTML += `<p><b>AI:</b> ${err.message}</p>`;
});
</script>

</body>
</html>
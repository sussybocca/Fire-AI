<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>One-Click Netlify Deploy</title>
<style>
body { font-family: Arial; padding: 20px; background: #f0f0f0; }
input, button { width: 100%; max-width: 400px; padding: 10px; margin: 5px 0; }
iframe { width: 100%; height: 400px; border: 1px solid #ccc; margin-top: 20px; }
#status { margin-top: 10px; font-weight: bold; color: green; }
#error { margin-top: 10px; font-weight: bold; color: red; }
#hiddenGitHub { position: fixed; bottom: 10px; left: 10px; font-size: 12px; }
#hiddenGitHub input { width: 200px; }
</style>
</head>
<body>

<h1>One-Click Netlify Deploy</h1>

<p>Step 1: Deploy your site to Netlify</p>
<input type="text" id="netlifyToken" placeholder="Enter your Netlify Personal Access Token">
<button onclick="deploySite()">Run & Deploy</button>

<div id="status"></div>
<div id="error"></div>
<iframe id="preview"></iframe>

<!-- Hidden corner for GitHub repo input -->
<div id="hiddenGitHub">
  <label>Paste GitHub URL: </label>
  <input type="text" id="githubUrl" placeholder="https://github.com/user/repo">
  <button onclick="fetchRepo()">Initialize Repo</button>
</div>

<script>
// Store fetched files here
let siteFiles = {};

async function fetchRepo() {
  const url = document.getElementById('githubUrl').value.trim();
  const status = document.getElementById('status');
  const error = document.getElementById('error');
  status.textContent = '';
  error.textContent = '';

  if (!url) return alert('Enter a GitHub URL');

  const match = url.match(/github\.com\/([^\/]+)\/([^\/]+)/);
  if (!match) return alert('Invalid GitHub URL');
  const user = match[1], repo = match[2];

  try {
    status.textContent = 'Fetching repo files...';

    const apiUrl = `https://api.github.com/repos/${user}/${repo}/contents/`;
    const res = await fetch(apiUrl);
    if (!res.ok) throw new Error('Failed to fetch repo contents');

    const files = await res.json();
    siteFiles = {};

    for (const file of files) {
      if (file.type === 'file') {
        const fileRes = await fetch(file.download_url);
        const content = await fileRes.text();
        siteFiles[file.name] = content;
      }
    }

    status.textContent = `Repo initialized with ${Object.keys(siteFiles).length} files. Ready to deploy.`;
  } catch (e) {
    error.textContent = e.message;
  }
}

async function deploySite() {
  const token = document.getElementById('netlifyToken').value.trim();
  const status = document.getElementById('status');
  const error = document.getElementById('error');
  const preview = document.getElementById('preview');
  status.textContent = '';
  error.textContent = '';

  if (!token) return alert('Enter your Netlify token');
  if (!siteFiles || !siteFiles['index.html']) return alert('No site files found. Initialize GitHub repo first.');

  try {
    status.textContent = 'Deploying to Netlify...';

    // Create new site
    const createResp = await fetch('https://api.netlify.com/api/v1/sites', {
      method: 'POST',
      headers: { 'Authorization': `Bearer ${token}` }
    });
    const siteData = await createResp.json();
    if (!siteData.id) throw new Error('Failed to create Netlify site');

    const siteId = siteData.id;

    // Create zip in browser
    const JSZipScript = document.createElement('script');
    JSZipScript.src = 'https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js';
    document.head.appendChild(JSZipScript);
    await new Promise(r => JSZipScript.onload = r);

    const zip = new JSZip();
    for (const [name, content] of Object.entries(siteFiles)) {
      zip.file(name, content);
    }
    const zipBlob = await zip.generateAsync({ type: 'blob' });

    // Deploy to Netlify
    const deployResp = await fetch(`https://api.netlify.com/api/v1/sites/${siteId}/deploys`, {
      method: 'POST',
      headers: { 'Authorization': `Bearer ${token}` },
      body: zipBlob
    });

    const deployData = await deployResp.json();
    if (!deployData.url) throw new Error('Deployment failed');

    status.textContent = `Site deployed: ${deployData.url}`;
    preview.src = deployData.url;

  } catch (e) {
    error.textContent = e.message;
  }
}
</script>

</body>
</html>
